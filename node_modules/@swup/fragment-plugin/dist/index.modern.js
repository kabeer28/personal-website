import t from"@swup/plugin";import{Location as r,classify as e,matchPath as n}from"swup";function s(){return s=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var e=arguments[r];for(var n in e)({}).hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t},s.apply(null,arguments)}window.process||(window.process={}),window.process.env||(window.process.env={});const o=["test"].includes(String(process.env.NODE_ENV)),i=["development","test"].includes(String(process.env.NODE_ENV)),l=(t,r,e)=>null==t?t:`[${r}m${String(t)}[${e}m`,a=t=>o?t:`ðŸ§© ${(t=>l(t,1,22))(t)}`,u=t=>o?t:(t=>l(t,94,39))(t);class c{log(...t){const r=t.shift();console.log(a(r),...t)}warn(...t){const r=t.shift();console.warn(a(r),...t)}error(...t){const r=t.shift();console.error(a(r),...t)}logIf(t,...r){t&&this.log(...r)}warnIf(t,...r){t&&this.warn(...r)}errorIf(t,...r){t&&this.error(...r)}}const g=t=>{!function({parsedRules:t,swup:e,logger:n}){const s=e.getCurrentUrl();t.filter(t=>t.matchesFrom(s)||t.matchesTo(s)).forEach(t=>{t.containers.forEach(t=>{const o=y(`${t}:not([data-swup-fragment])`,e);if(!o)return;const l=o.getAttribute("data-swup-fragment-url");l&&i&&(null==n||n.log(`fragment url ${u(l)} for ${u(t)} provided by server`));const{url:a}=r.fromUrl(l||s);o.setAttribute("data-swup-fragment",""),o.__swupFragment={url:a,selector:t}})})}(t),function({logger:t,swup:r}){const e="data-swup-link-to-fragment";document.querySelectorAll(`a[${e}]`).forEach(n=>{var s;const o=n.getAttribute(e);if(!o)return void(i&&(null==t||t.warn(`[${e}] needs to contain a valid fragment selector`)));const l=y(o,r);if(!l)return void(i&&(null==t||t.log(`ignoring ${u(`[${e}="${o}"]`)} as ${u(o)} is missing`)));const a=null==(s=l.__swupFragment)?void 0:s.url;a?(m(a,r.getCurrentUrl())&&i&&(null==t||t.warn(`The fragment URL of ${o} is identical to the current URL. This could mean that [data-swup-fragment-url] needs to be provided by the server.`)),n.href=a):i&&(null==t||t.warn(`no fragment infos found on ${o}`))})}(t),function({logger:t}){document.querySelectorAll("dialog[data-swup-fragment]").forEach(r=>{r.__swupFragment?r.__swupFragment.modalShown||(r.__swupFragment.modalShown=!0,r.removeAttribute("open"),null==r.showModal||r.showModal(),r.addEventListener("keydown",t=>"Escape"===t.key&&t.preventDefault())):i&&(null==t||t.warn("fragment properties missing on element:",r))})}(t)},f=(t,r)=>{var e;const n=null==(e=t.__swupFragment)?void 0:e.url;return!!n&&m(n,r)},m=(t,r)=>h(t)===h(r),h=t=>{if(!t.trim())return t;const e=r.fromUrl(t);return e.searchParams.sort(),e.pathname.replace(/\/+$/g,"")+e.search},p=t=>{const r=t.from.url,e=t.to.url;if(r&&e)return{from:r,to:e}},d=(t,r)=>{if(null==t||!t.name)return;const{name:e,containers:n}=t;n.forEach(t=>{var n;null==(n=document.querySelector(t))||n.classList.toggle(`to-${e}`,r)})},w=(t,r,e)=>r.find(r=>r.matches(t,e));function v(t){return!!t&&t.containers.every(t=>{var r;return"template"===(null==(r=document.querySelector(t))||null==(r=r.tagName)?void 0:r.toLowerCase())})}function y(t,r){for(const e of r.options.containers){const r=document.querySelector(e);if(null!=r&&r.matches(t))return r;const n=null==r?void 0:r.querySelector(t);if(n)return n}}function S(t){if(!Array.isArray(t))throw new Error("cloneRules() expects an array of rules");return t.map(t=>s({},t,{from:Array.isArray(t.from)?[...t.from]:t.from,to:Array.isArray(t.to)?[...t.to]:t.to,containers:[...t.containers]}))}class ${constructor(t){var r,s;this.matchesFrom=void 0,this.matchesTo=void 0,this.swup=void 0,this.from=void 0,this.to=void 0,this.containers=void 0,this.name=void 0,this.scroll=!1,this.focus=void 0,this.logger=void 0,this.if=()=>!0,this.swup=t.swup,this.logger=t.logger,this.from=t.from||"",this.to=t.to||"",t.name&&(this.name=e(t.name)),void 0!==t.scroll&&(this.scroll=t.scroll),void 0!==t.focus&&(this.focus=t.focus),"function"==typeof t.if&&(this.if=t.if),this.containers=this.parseContainers(t.containers),i&&(null==(r=this.logger)||r.errorIf(!this.to,"Every fragment rule must contain a 'to' path",this),null==(s=this.logger)||s.errorIf(!this.from,"Every fragment rule must contain a 'from' path",this)),this.matchesFrom=n(this.from),this.matchesTo=n(this.to)}parseContainers(t){var r,e;return Array.isArray(t)&&t.length?(e=t.map(t=>t.trim()),[...new Set(e)]).filter(t=>{var r;const e=this.validateSelector(t);return null==(r=this.logger)||r.errorIf(e instanceof Error,e),!0===e}):(i&&(null==(r=this.logger)||r.error("Every fragment rule must contain an array of containers",this.getDebugInfo())),[])}validateSelector(t){return t.startsWith("#")?!t.match(/\s|>/)||new Error(`fragment selectors must not be nested: ${t}`):new Error(`fragment selectors must be IDs: ${t}`)}getDebugInfo(){const{from:t,to:r,containers:e}=this;return{from:String(t),to:String(r),containers:String(e)}}matches(t,e){var n;if(!this.if(e))return i&&(null==(n=this.logger)||n.log("ignoring fragment rule due to custom rule.if:",this)),!1;const{url:s}=r.fromUrl(t.from),{url:o}=r.fromUrl(t.to);if(!this.matchesFrom(s)||!this.matchesTo(o))return!1;for(const t of this.containers){const r=this.validateFragmentSelectorForMatch(t);var l;if(r instanceof Error)return i&&(null==(l=this.logger)||l.error(r,this.getDebugInfo())),!1}return!0}validateFragmentSelectorForMatch(t){return document.querySelector(t)?!!y(t,this.swup)||new Error(`skipping rule since ${u(t)} is outside of swup's default containers`):new Error(`skipping rule since ${u(t)} doesn't exist in the current document`)}}const _=function(t){const r=p(t);r&&w(r,this.parsedRules,t)&&(t.scroll.reset=!1)},R=async function(t){const r=p(t);if(!r)return;const e=this.getFragmentVisit(r,t);if(!e)return;var n;t.fragmentVisit=e,i&&(null==(n=this.logger)||n.log(`fragment visit: ${u(t.fragmentVisit.containers.join(", "))}`)),t.scroll=function(t,r){return"boolean"==typeof t.scroll?s({},r,{reset:t.scroll}):"string"!=typeof t.scroll||r.target?r:s({},r,{target:t.scroll})}(e,t.scroll);const o=t.a11y;var l;void 0!==e.focus&&(i&&(null==(l=this.logger)||l.errorIf(!o,"Can't set visit.a11y.focus. Is @swup/a11y-plugin installed?")),o&&(o.focus=e.focus)),t.animation.scope=t.fragmentVisit.containers,t.containers=t.fragmentVisit.containers,t.animation.selector=t.fragmentVisit.containers.join(","),d(e,!0)},b=function(t,r){var e,n;t.fragmentVisit&&v(t.fragmentVisit)&&(i&&(null==(e=this.logger)||e.log(`${u("out")}-animation skipped for ${u(null==(n=t.fragmentVisit)?void 0:n.containers.toString())}`)),r.skip=!0)},E=function(t,r){var e,n;t.fragmentVisit&&v(t.fragmentVisit)&&(i&&(null==(e=this.logger)||e.log(`${u("in")}-animation skipped for ${u(null==(n=t.fragmentVisit)?void 0:n.containers.toString())}`)),r.skip=!0)},F=function(t,r){var e;if(t.trigger.el||!t.to.url)return;const n=this.swup.cache.get(t.to.url);n&&n.fragmentHtml&&(t.to.document=(new DOMParser).parseFromString(n.fragmentHtml,"text/html"),t.to.html=n.fragmentHtml,i&&(null==(e=this.logger)||e.log(`fragment cache used for ${u(t.to.url)}`)))},A=function(t){d(t.fragmentVisit,!0),g(this),(({swup:t,logger:r})=>{const e=t.getCurrentUrl(),n=t.cache,s=n.get(e);if(!s)return;const o=(new DOMParser).parseFromString(s.html,"text/html"),l=[],a=Array.from(document.querySelectorAll("[data-swup-fragment]")).filter(t=>!t.matches("template")&&!f(t,e));a.length&&(t.options.cache?(a.forEach(t=>{var e,s;if(null!=t.querySelector("[data-swup-fragment]"))return;const a=null==(e=t.__swupFragment)?void 0:e.url;if(!a)return void(i&&(null==r||r.warn("no fragment url found:",t)));const u=null==(s=t.__swupFragment)?void 0:s.selector;if(!u)return void(i&&(null==r||r.warn("no fragment selector found:",t)));const c=n.get(a);if(!c)return;const g=o.querySelector(u);if(!g)return;const f=(new DOMParser).parseFromString(c.html,"text/html").querySelector(u);f&&(f.setAttribute("data-swup-fragment-url",a),g.replaceWith(f),l.push(t))}),l.length&&(n.update(e,{fragmentHtml:o.documentElement.outerHTML}),l.forEach(t=>{var e,n;const s=(null==(e=t.__swupFragment)?void 0:e.url)||"",o=(null==(n=t.__swupFragment)?void 0:n.selector)||"";i&&(null==r||r.log(`updated cache with ${u(o)} from ${u(s)}`))}))):i&&(null==r||r.warn("can't cache foreign fragment elements without swup's cache")))})(this)},V=function(t){d(t.fragmentVisit,!1)};class q extends t{get parsedRules(){return this._parsedRules}constructor(t){super(),this.name="SwupFragmentPlugin",this.requires={swup:">=4.6"},this._rawRules=[],this._parsedRules=[],this.options=void 0,this.defaults={rules:[],debug:!1},this.logger=void 0,this.options=s({},this.defaults,t)}mount(){const t=this.swup;var r;this.setRules(this.options.rules),i&&this.options.debug&&(this.logger=new c),this.before("link:self",_),this.on("visit:start",R),this.before("animation:out:await",b),this.before("animation:in:await",E),this.before("content:replace",F),this.on("content:replace",A),this.on("visit:end",V),i&&(null==(r=this.logger)||r.warnIf(!t.options.cache,"fragment caching will only work with swup's cache being active")),g(this)}unmount(){super.unmount(),document.querySelectorAll("[data-swup-fragment]").forEach(t=>{t.removeAttribute("data-swup-fragment-url"),delete t.__swupFragment})}setRules(t){var r;this._rawRules=S(t),this._parsedRules=t.map(t=>this.parseRule(t)),i&&(null==(r=this.logger)||r.log("Updated fragment rules",this.getRules()))}getRules(){return S(this._rawRules)}prependRule(t){this.setRules([t,...this.getRules()])}appendRule(t){this.setRules([...this.getRules(),t])}parseRule(t){return new $(s({},t,{logger:this.logger,swup:this.swup}))}getFragmentVisit(t,r){const e=w(t,this.parsedRules,r||this.swup.createVisit(t));if(!e)return;const n=((t,r,e,n)=>{let s=r.map(t=>{const r=document.querySelector(t);return r?y(t,e)?{selector:t,el:r}:(i&&(null==n||n.error(`${u(t)} is outside of swup's default containers`)),!1):(i&&(null==n||n.log(`${u(t)} missing in current document`)),!1)}).filter(t=>!!t);const o=s.every(r=>f(r.el,t.to));return m(t.from,t.to)||o&&"navigate"===e.options.linkToSelf||(s=s.filter(r=>!f(r.el,t.to)||(i&&(null==n||n.log(`ignoring fragment ${u(r.selector)} as it already matches the current URL`)),!1))),s.map(t=>t.selector)})(t,e.containers,this.swup,this.logger);if(!n.length)return;const{name:s,scroll:o,focus:l}=e;return{containers:n,name:s,scroll:o,focus:l}}}export{q as default};
//# sourceMappingURL=index.modern.js.map
